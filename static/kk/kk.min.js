kk={};(function(a){a.Object=function(){};a.Object.prototype.init=function(){return this};a.get=function(c,d){var e;if(d instanceof Array){e=d}else{e=d.split(".")}var b=c;while(e.length>0){d=e.shift();if(typeof b=="object"){b=b[d]}else{return}}return b};a.set=function(c,d,g){var e;if(d instanceof Array){e=d}else{e=d.split(".")}var b=c;while(e.length>0){d=e.shift();if(e.length==0){b[d]=g}else{var f=b[d];if(typeof f!="object"){f={};b[d]=f}b=f}}};a.remove=function(c,d){var e;if(d instanceof Array){e=d}else{e=d.split(".")}var b=c;while(e.length>0){d=e.shift();if(e.length==0){delete b[d]}else{var f=b[d];if(typeof f!="object"){return}b=f}}}})(kk);(function(a){a.Event=function(){};a.Event.prototype=new a.Object();a.Event.prototype.init=function(){a.Object.prototype.init.apply(this,arguments);this._fns=[];return this};a.Event.prototype.on=function(c,b){this._fns.push({pattern:c,fn:b})};a.Event.prototype.off=function(g,d){var c=[];for(var b in this._fns){var e=this._fns[b];if((g===null||g==e.pattern)&&(d===null||e.fn==d)){}else{c.push(e)}}this._fns=c};a.Event.prototype.emit=function(c){var b=[];for(var e=1;e<arguments.length;e++){b.push(arguments[e])}var d=[];for(var e in this._fns){var g=this._fns[e];if(typeof g.pattern=="object"){if(g.pattern.test(c)){d.push(g)}}else{if(g.pattern==c){d.push(g)}}}for(var e in d){var g=d[e];g.fn.apply(this,b)}}})(kk);(function(kk){var stringValue=function(v){if(v===undefined||v===null){return""}else{if(typeof v=="string"){return v}}return v+""};var elementValue=function(element,v){var fn=element.getAttribute("kk-fn");if(fn!=null){try{fn=eval(fn)}catch(e){}if(typeof fn=="function"){v=fn.call(this.element,v)}}return v};var Bind=function(){};Bind.prototype=new kk.Object();Bind.prototype.init=function(element){kk.Object.prototype.init.apply(this,arguments);this.element=element;this.views=[];if(this.element.nodeType==3){this.text=this.element.textContent}return this};Bind.prototype.set=function(object,view){if(this.element.changing){return}if(this.element.nodeType==3){this.element.textContent=this.text.replace(/\{\{([a-zA-Z0-9_\.]*?)\}\}/g,function(match,key){var v=kk.get(object,key);return stringValue(v)})}else{var key=this.element.getAttribute("kk-each");if(typeof key=="string"){var v=kk.get(object,key);v=elementValue(this.element,v);var vs;if(v instanceof Array){vs=v}else{vs=[v]}var i=0;for(i=0;i<vs.length;i++){v=vs[i];var vv;if(i<this.views.length){vv=this.views[i];vv.parent=view;vv.baseKey=view.absoluteKey(key+"."+i);if(v instanceof Object){vv.set(v)}else{vv.set("text",v)}}else{vv=kk.view(this.element.cloneNode(true));vv.parent=view;vv.baseKey=view.absoluteKey(key+"."+i);if(v instanceof Object){vv.set(v)}else{vv.set("text",v)}$(vv.element).removeClass("kk-view");if(this.element.parentNode){this.element.parentNode.insertBefore(vv.element,this.element)}this.views.push(vv)}}while(i<this.views.length){var vv=this.views.pop();if(vv.element.parentNode){vv.element.parentNode.removeChild(vv.element)}}}else{key=this.element.getAttribute("kk-key");if(typeof key=="string"){var v=kk.get(object,key);v=elementValue(this.element,v);if(this.element.value===undefined){this.element.textContent=stringValue(v)}else{this.element.value=stringValue(v)}}}}};var Relationship=function(){};Relationship.prototype=new kk.Object();Relationship.prototype.init=function(){kk.Object.prototype.init.apply(this,arguments);this.binds=[];this.relationship={};return this};Relationship.prototype.set=function(object,view,dispatch){for(var i in this.binds){var bind=this.binds[i];bind.set(object,view)}if(dispatch){for(var key in this.relationship){var v=this.relationship[key];v.set(object,view,dispatch)}}};kk.View=function(){};kk.View.prototype=new kk.Event();kk.View.prototype.init=function(element){kk.Event.prototype.init.apply(this,arguments);this.object={};this.relationship=(new Relationship()).init();this.element=element;var p=element.firstChild;while(p){this.relation(p);p=p.nextSibling}var me=this;$(element).on("change",function(e){var element=e.target;var key=element.getAttribute("kk-key");if(typeof key=="string"){kk.set(me.object,key,element.value);var k=me.absoluteKey(key);var v=me;while(v.parent){v=v.parent}element.changing=true;v.change(k);delete element.changing;v.emit("change",{key:k,object:v.object,element:element,view:me})}e.stopPropagation()});return this};kk.View.prototype.absoluteKey=function(key){if(this.parent===undefined){return key}return this.baseKey+"."+key};kk.View.prototype.bind=function(key,bind){var keys;if(key instanceof Array){keys=key}else{keys=key.split(".")}var r=this.relationship;while(keys.length>0){key=keys.shift();var v=r.relationship[key];if(v===undefined){v=(new Relationship()).init();r.relationship[key]=v}v.binds.push(bind);r=v}};kk.View.prototype.relation=function(element){if(element.nodeType==3){var v;var me=this;element.textContent.replace(/\{\{([a-zA-Z0-9\._]*?)\}\}/g,function(match,key){var i=key.indexOf(",");if(i>=0){key=key.substr(0,i)}if(v===undefined){v=(new Bind()).init(element)}me.bind(key,v)})}else{if(element.nodeType==1){var key=element.getAttribute("kk-each");if(typeof key=="string"){this.bind(key,(new Bind()).init(element))}else{key=element.getAttribute("kk-key");if(typeof key=="string"){this.bind(key,(new Bind()).init(element))}var p=element.firstChild;while(p){this.relation(p);p=p.nextSibling}}}}};kk.View.prototype.change=function(key){if(key===undefined){this.relationship.set(this.object,this,true);return}var keys;if(typeof key=="string"){keys=key.split(".")}else{if(key instanceof Array){keys=key}else{return}}var r=this.relationship;while(keys.length>0){if(r!==undefined){r.set(this.object,this)}var key=keys.shift();if(keys.length==0){if(r!==undefined){r=r.relationship[key];if(r!==undefined){r.set(this.object,this)}}}else{if(r!==undefined){r=r.relationship[key]}}}};kk.View.prototype.set=function(key,value){if(key instanceof Object&&value===undefined){this.object=key;this.relationship.set(this.object,this,true);return}kk.set(this.object,key,value);this.change(key)};kk.view=function(element){if(typeof element=="string"){var v=document.createElement("div");v.innerHTML=element;element=v}return(new kk.View()).init(element)}})(kk);